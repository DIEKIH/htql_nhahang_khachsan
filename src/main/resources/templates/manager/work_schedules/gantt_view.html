<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý lịch làm việc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/manager_sidebar.css}">
    <style>
        :root {
            --row-height: 45px;
            --day-width: 85px;
        }

        body { font-size: 0.8rem; background: #f5f7fa; }
        h2, h5 { font-size: 1.2rem; margin: 0; }
        .btn { font-size: 0.75rem; padding: 0.3rem 0.6rem; }
        .btn-sm { font-size: 0.7rem; padding: 0.2rem 0.4rem; }
        .form-label { font-size: 0.75rem; margin-bottom: 0.3rem; }
        .form-control, .form-select { font-size: 0.75rem; padding: 0.3rem 0.5rem; }
        .badge { font-size: 0.7rem; }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .controls-wrapper {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .btn-nav {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }

        .btn-nav:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            border: 2px solid;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .stat-card .stat-label {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .stat-card .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .card-header { padding: 12px 15px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); }
        .card-body { padding: 12px; }

        /* Timeline Gantt */
        .timeline-wrapper {
            background: #fff;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
        }

        .timeline-header {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
        }

        .staff-header {
            width: 180px;
            padding: 12px;
            font-weight: 600;
            border-right: 2px solid #e9ecef;
            font-size: 0.75rem;
        }

        .days-header {
            display: flex;
            flex: 1;
            overflow-x: auto;
        }

        .day-cell {
            min-width: var(--day-width);
            padding: 10px 6px;
            text-align: center;
            border-right: 1px solid #e9ecef;
            font-size: 0.7rem;
            transition: background 0.2s;
        }

        .day-cell:hover { background: #f0f0f0; }
        .day-cell.today { background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); font-weight: 600; }

        .timeline-body {
            display: flex;
            flex: 1;
            overflow: auto;
            max-height: 500px;
        }

        .staff-column {
            width: 180px;
            border-right: 2px solid #e9ecef;
            background: #fafbfc;
        }

        .staff-row {
            height: var(--row-height);
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.75rem;
        }

        .staff-row:hover { background: #f0f0f0; }

        .staff-name {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .staff-phone {
            font-size: 0.65rem;
            color: #6c757d;
        }

        .grid-container {
            position: relative;
            flex: 1;
        }

        .grid-row {
            height: var(--row-height);
            position: relative;
            border-bottom: 1px solid #e9ecef;
            display: flex;
        }

        .grid-cell {
            min-width: var(--day-width);
            border-right: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .grid-cell:hover { background: #f8f9fa; }
        .grid-cell.today { background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%); }

        .shift-block {
            position: absolute;
            height: 35px;
            top: 5px;
            border-radius: 6px;
            color: #fff;
            padding: 4px 8px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .shift-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            z-index: 20;
        }

        .shift-block.type-MORNING { background: linear-gradient(135deg, #17a2b8, #138496); }
        .shift-block.type-AFTERNOON { background: linear-gradient(135deg, #ffc107, #ff9800); }
        .shift-block.type-EVENING { background: linear-gradient(135deg, #007bff, #0056b3); }
        .shift-block.type-NIGHT { background: linear-gradient(135deg, #343a40, #23272b); }
        .shift-block.type-FULL_DAY { background: linear-gradient(135deg, #28a745, #218838); }
        .shift-block.type-OFF { background: linear-gradient(135deg, #6c757d, #545b62); opacity: 0.5; }

        .shift-block.has-checkin { border: 2px solid #fff; }
        .shift-block.has-checkout { opacity: 0.7; }

        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tooltip-custom {
            position: fixed;
            background: #222;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 1000;
            pointer-events: none;
            display: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .modal-content { font-size: 0.75rem; }
        .modal-header { padding: 10px 15px; }
        .modal-body { padding: 15px; }
        .modal-footer { padding: 10px 15px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div th:replace="fragments/manager_sidebar :: manager_sidebar"></div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="page-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h2><i class="bi bi-calendar3-week"></i> Quản lý lịch làm việc - Gantt View</h2>
                        <p class="mb-0" style="opacity: 0.9; font-size: 0.7rem;">Phân công và chấm công nhân viên theo tuần</p>
                    </div>
                    <button class="btn btn-light btn-sm" onclick="showAddScheduleModal()">
                        <i class="bi bi-plus-circle"></i> Thêm lịch
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2><i class="bi bi-calendar3"></i> Quản lý ca làm việc</h2>
                    <a href="/manager/work-schedules/add" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Thêm ca làm việc
                    </a>
                </div>
                <div class="controls-wrapper">
                    <button class="btn-nav" onclick="navigate(-1)"><i class="bi bi-chevron-left"></i> Trước</button>
                    <button class="btn-nav" onclick="navigateToday()"><i class="bi bi-calendar-check"></i> Tuần này</button>
                    <button class="btn-nav" onclick="navigate(1)">Sau <i class="bi bi-chevron-right"></i></button>
                    <button class="btn-nav" onclick="refreshData()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-color: #667eea;">
                    <div class="stat-label">Tổng nhân viên</div>
                    <div class="stat-value" id="totalStaff">0</div>
                </div>
                <div class="stat-card" style="border-color: #28a745;">
                    <div class="stat-label">Đã check-in</div>
                    <div class="stat-value" id="checkedIn">0</div>
                </div>
                <div class="stat-card" style="border-color: #ffc107;">
                    <div class="stat-label">Chưa check-in</div>
                    <div class="stat-value" id="notCheckedIn">0</div>
                </div>
                <div class="stat-card" style="border-color: #dc3545;">
                    <div class="stat-label">Vắng mặt</div>
                    <div class="stat-value" id="absent">0</div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="bi bi-funnel"></i> Chú thích ca làm việc</h5>
                </div>
                <div class="card-body">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #17a2b8, #138496);"></div>
                            <span>Ca sáng</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #ffc107, #ff9800);"></div>
                            <span>Ca chiều</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #007bff, #0056b3);"></div>
                            <span>Ca tối</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #343a40, #23272b);"></div>
                            <span>Ca đêm</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, #28a745, #218838);"></div>
                            <span>Ca full</span>
                        </div>
                        <div class="legend-item">
                            <span style="border: 2px solid white; padding: 2px 8px; background: #333; color: white; border-radius: 4px;">Đã check-in</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart-line"></i> Sơ đồ Gantt - <span id="weekRange">Loading...</span></h5>
                </div>
                <div class="card-body p-0">
                    <div class="timeline-wrapper">
                        <div class="timeline-header">
                            <div class="staff-header">Nhân viên</div>
                            <div class="days-header" id="daysHeader"></div>
                        </div>
                        <div class="timeline-body">
                            <div class="staff-column" id="staffColumn"></div>
                            <div class="grid-container" id="gridContainer">
                                <div id="gridRows"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tooltip-custom" id="tooltip"></div>
        </main>
    </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Thêm lịch làm việc tuần</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nhân viên <span class="text-danger">*</span></label>
                    <select id="staffSelect" class="form-select" required>
                        <option value="">-- Chọn nhân viên --</option>
                        <option th:each="staff : ${staffList}" th:value="${staff.id}"
                                th:text="${staff.fullName} + ' (' + ${staff.phoneNumber} + ')'"></option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tuần bắt đầu (Thứ 2) <span class="text-danger">*</span></label>
                    <input type="date" id="weekStartInput" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Lịch làm việc trong tuần</label>
                    <table class="table table-sm table-bordered">
                        <thead>
                        <tr>
                            <th>Thứ</th>
                            <th>Ca làm</th>
                            <th>Giờ</th>
                        </tr>
                        </thead>
                        <tbody id="weekScheduleTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveSchedule()">
                    <i class="bi bi-save"></i> Lưu lịch
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clock"></i> Chấm công</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="attendanceModalBody"></div>
            <div class="modal-footer" id="attendanceModalFooter"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const state = {
        weekStart: getMonday(new Date()),
        schedules: [],
        staffList: []
    };

    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    async function loadData() {
        try {
            const startDate = formatDate(state.weekStart);
            const endDate = formatDate(addDays(state.weekStart, 13)); // 2 weeks

            const res = await fetch(`/manager/work-schedules/api/schedules?startDate=${startDate}&endDate=${endDate}`);
            state.schedules = await res.json();

            render();
        } catch (error) {
            console.error('Error:', error);
            alert('Không thể tải dữ liệu');
        }
    }

    function render() {
        renderDaysHeader();
        renderStaffAndGrid();
        renderShifts();
        updateStats();
    }

    function renderDaysHeader() {
        const header = document.getElementById('daysHeader');
        const weekRange = document.getElementById('weekRange');
        header.innerHTML = '';

        const endDate = addDays(state.weekStart, 6);
        weekRange.textContent = `${formatDate(state.weekStart)} → ${formatDate(endDate)}`;

        const days = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'CN'];
        const today = formatDate(new Date());

        for (let i = 0; i < 7; i++) {
            const date = addDays(state.weekStart, i);
            const dateStr = formatDate(date);
            const dayNum = date.getDate() + '/' + (date.getMonth() + 1);

            const cell = document.createElement('div');
            cell.className = 'day-cell' + (dateStr === today ? ' today' : '');
            cell.innerHTML = `<div style="font-weight: 600;">${days[i]}</div><div style="font-size: 0.65rem; margin-top: 2px;">${dayNum}</div>`;
            header.appendChild(cell);
        }
    }

    function renderStaffAndGrid() {
        const staffCol = document.getElementById('staffColumn');
        const gridRows = document.getElementById('gridRows');
        staffCol.innerHTML = '';
        gridRows.innerHTML = '';

        // Get unique staff
        const staffMap = new Map();
        state.schedules.forEach(s => {
            if (!staffMap.has(s.staffId)) {
                staffMap.set(s.staffId, { id: s.staffId, name: s.staffName, phone: s.staffPhone });
            }
        });

        staffMap.forEach(staff => {
            const staffDiv = document.createElement('div');
            staffDiv.className = 'staff-row';
            staffDiv.innerHTML = `
            <div class="staff-name">${staff.name}</div>
            <div class="staff-phone"><i class="bi bi-phone"></i> ${staff.phone || ''}</div>
        `;
            staffCol.appendChild(staffDiv);

            const gridRow = document.createElement('div');
            gridRow.className = 'grid-row';
            gridRow.dataset.staffId = staff.id;

            const today = formatDate(new Date());
            for (let i = 0; i < 7; i++) {
                const date = formatDate(addDays(state.weekStart, i));
                const cell = document.createElement('div');
                cell.className = 'grid-cell' + (date === today ? ' today' : '');
                cell.dataset.date = date;
                gridRow.appendChild(cell);
            }

            gridRows.appendChild(gridRow);
        });
    }

    // function renderShifts() {
    //     const gridRows = document.getElementById('gridRows');
    //
    //     state.schedules.forEach(schedule => {
    //         const row = gridRows.querySelector(`[data-staff-id="${schedule.staffId}"]`);
    //         if (!row) return;
    //
    //         Object.values(schedule.shiftsByDay || {}).forEach(shift => {
    //             if (!shift.date) return;
    //
    //             const daysDiff = Math.floor((new Date(shift.date) - state.weekStart) / (1000 * 60 * 60 * 24));
    //             if (daysDiff < 0 || daysDiff >= 7) return;
    //
    //             const leftPx = daysDiff * 85;
    //             const widthPx = 80;
    //
    //             const block = document.createElement('div');
    //             block.className = `shift-block type-${shift.type}`;
    //             if (shift.attendance?.checkIn) block.classList.add('has-checkin');
    //             if (shift.attendance?.checkOut) block.classList.add('has-checkout');
    //
    //             block.style.left = leftPx + 'px';
    //             block.style.width = widthPx + 'px';
    //             block.dataset.shiftId = shift.id;
    //
    //             block.innerHTML = `<span>${shift.typeDisplayName}</span>`;
    //
    //             block.addEventListener('mouseenter', (e) => showTooltip(e, shift, schedule.staffName));
    //             block.addEventListener('mouseleave', hideTooltip);
    //             block.addEventListener('click', () => showAttendanceModal(shift, schedule.staffName));
    //
    //             row.appendChild(block);
    //         });
    //     });
    // }

    function renderShifts() {
        const gridRows = document.getElementById('gridRows');

        state.schedules.forEach(schedule => {
            const row = gridRows.querySelector(`[data-staff-id="${schedule.staffId}"]`);
            if (!row) return;

            Object.values(schedule.shiftsByDay || {}).forEach(shift => {
                if (!shift.date) return;

                // ✅ SỬA: Chuẩn hóa cả 2 ngày về 00:00:00 trước khi tính
                const shiftDate = new Date(shift.date);
                shiftDate.setHours(0, 0, 0, 0);

                const weekStartNormalized = new Date(state.weekStart);
                weekStartNormalized.setHours(0, 0, 0, 0);

                const daysDiff = Math.floor((shiftDate - weekStartNormalized) / (1000 * 60 * 60 * 24));

                if (daysDiff < 0 || daysDiff >= 7) return;

                const leftPx = daysDiff * 85;
                const widthPx = 80;

                const block = document.createElement('div');
                block.className = `shift-block type-${shift.type}`;
                if (shift.attendance?.checkIn) block.classList.add('has-checkin');
                if (shift.attendance?.checkOut) block.classList.add('has-checkout');

                block.style.left = leftPx + 'px';
                block.style.width = widthPx + 'px';
                block.dataset.shiftId = shift.id;

                block.innerHTML = `<span>${shift.typeDisplayName}</span>`;

                block.addEventListener('mouseenter', (e) => showTooltip(e, shift, schedule.staffName));
                block.addEventListener('mouseleave', hideTooltip);
                block.addEventListener('click', () => showAttendanceModal(shift, schedule.staffName));

                row.appendChild(block);
            });
        });
    }

    function showTooltip(e, shift, staffName) {
        const tooltip = document.getElementById('tooltip');
        tooltip.style.display = 'block';
        tooltip.style.left = e.pageX + 'px';
        tooltip.style.top = (e.pageY - 60) + 'px';

        let html = `
        <strong>${staffName}</strong><br>
        ${shift.dayDisplayName} - ${shift.formattedDate}<br>
        ${shift.typeDisplayName}: ${shift.formattedTime}<br>
    `;

        if (shift.attendance) {
            html += `<hr style="margin: 5px 0;">`;
            html += `Check-in: ${shift.attendance.formattedCheckIn || 'Chưa'}<br>`;
            html += `Check-out: ${shift.attendance.formattedCheckOut || 'Chưa'}<br>`;
            html += `Trạng thái: ${shift.attendance.attendanceStatusDisplay}`;
        } else {
            html += `<span class="badge bg-warning">Chưa chấm công</span>`;
        }

        tooltip.innerHTML = html;
    }

    function hideTooltip() {
        document.getElementById('tooltip').style.display = 'none';
    }

    function showAttendanceModal(shift, staffName) {
        const modal = new bootstrap.Modal(document.getElementById('attendanceModal'));
        const body = document.getElementById('attendanceModalBody');
        const footer = document.getElementById('attendanceModalFooter');

        body.innerHTML = `
        <p><strong>Nhân viên:</strong> ${staffName}</p>
        <p><strong>Ca làm:</strong> ${shift.dayDisplayName} - ${shift.formattedDate}</p>
        <p><strong>Loại ca:</strong> <span class="badge ${shift.typeBadgeClass}">${shift.typeDisplayName}</span></p>
        <p><strong>Giờ:</strong> ${shift.formattedTime}</p>
        <hr>
        ${shift.attendance ? `
            <p><strong>Check-in:</strong> ${shift.attendance.formattedCheckIn || 'Chưa'}</p>
            <p><strong>Check-out:</strong> ${shift.attendance.formattedCheckOut || 'Chưa'}</p>
            <p><strong>Trạng thái:</strong> <span class="badge ${shift.attendance.attendanceStatusBadge}">${shift.attendance.attendanceStatusDisplay}</span></p>
        ` : '<p class="text-warning">Chưa có dữ liệu chấm công</p>'}
    `;

        footer.innerHTML = '<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>';

        if (!shift.attendance?.checkIn) {
            footer.innerHTML += `<button type="button" class="btn btn-success btn-sm" onclick="markAttendance(${shift.id}, true)">
            <i class="bi bi-box-arrow-in-right"></i> Check-in
        </button>`;
        }

        if (shift.attendance?.checkIn && !shift.attendance?.checkOut) {
            footer.innerHTML += `<button type="button" class="btn btn-primary btn-sm" onclick="markAttendance(${shift.id}, false)">
            <i class="bi bi-box-arrow-right"></i> Check-out
        </button>`;
        }

        modal.show();
    }

    async function markAttendance(shiftId, isCheckIn) {
        try {
            const res = await fetch('/manager/work-schedules/attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shiftId, checkIn: isCheckIn, time: new Date().toISOString() })
            });

            const data = await res.json();
            if (data.success) {
                alert(isCheckIn ? 'Check-in thành công!' : 'Check-out thành công!');
                bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
                loadData();
            } else {
                alert('Lỗi: ' + data.error);
            }
        } catch (error) {
            alert('Không thể chấm công');
        }
    }

    function showAddScheduleModal() {
        const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));

        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY', 'SUNDAY'];
        const dayNames = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'];
        const shiftTypes = ['MORNING', 'AFTERNOON', 'EVENING', 'NIGHT', 'FULL_DAY', 'OFF'];
        const shiftNames = ['Ca sáng', 'Ca chiều', 'Ca tối', 'Ca đêm', 'Ca full', 'Nghỉ'];

        const table = document.getElementById('weekScheduleTable');
        table.innerHTML = '';

        days.forEach((day, idx) => {
            const row = table.insertRow();
            row.innerHTML = `
            <td>${dayNames[idx]}</td>
            <td>
                <select class="form-select form-select-sm shift-type" data-day="${day}">
                    ${shiftTypes.map((t, i) => `<option value="${t}">${shiftNames[i]}</option>`).join('')}
                </select>
            </td>
            <td>
                <input type="time" class="form-control form-control-sm shift-start" data-day="${day}" value="08:00">
                <input type="time" class="form-control form-control-sm shift-end mt-1" data-day="${day}" value="17:00">
            </td>
        `;
        });

        modal.show();
    }

    async function saveSchedule() {
        const staffId = document.getElementById('staffSelect').value;
        const weekStart = document.getElementById('weekStartInput').value;

        if (!staffId || !weekStart) {
            alert('Vui lòng điền đầy đủ thông tin');
            return;
        }

        const shifts = [];
        document.querySelectorAll('.shift-type').forEach(select => {
            const day = select.dataset.day;
            const type = select.value;

            if (type === 'OFF') {
                shifts.push({
                    dayOfWeek: day,
                    type: type,
                    startTime: null,
                    endTime: null
                });
                return;
            }

            const startInput = document.querySelector(`.shift-start[data-day="${day}"]`);
            const endInput = document.querySelector(`.shift-end[data-day="${day}"]`);

            shifts.push({
                dayOfWeek: day,
                type: type,
                startTime: startInput.value,
                endTime: endInput.value
            });
        });

        try {
            const res = await fetch('/manager/work-schedules/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    staffId: parseInt(staffId),
                    weekStart: weekStart,
                    shifts: shifts
                })
            });

            const data = await res.json();
            if (data.error) {
                alert('Lỗi: ' + data.error);
            } else {
                alert('Thêm lịch làm việc thành công!');
                bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
                loadData();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Không thể lưu lịch làm việc');
        }
    }

    function navigate(direction) {
        state.weekStart = addDays(state.weekStart, direction * 7);
        loadData();
    }

    function navigateToday() {
        state.weekStart = getMonday(new Date());
        loadData();
    }

    function updateStats() {
        const today = formatDate(new Date());

        // Total staff
        const uniqueStaff = new Set(state.schedules.map(s => s.staffId));
        document.getElementById('totalStaff').textContent = uniqueStaff.size;

        // Count check-ins for today
        let checkedIn = 0;
        let notCheckedIn = 0;
        let absent = 0;

        state.schedules.forEach(schedule => {
            Object.values(schedule.shiftsByDay || {}).forEach(shift => {
                if (shift.date === today) {
                    if (shift.attendance?.checkIn) {
                        checkedIn++;
                    } else {
                        notCheckedIn++;
                    }

                    if (shift.attendance?.attendanceStatus === 'ABSENT') {
                        absent++;
                    }
                }
            });
        });

        document.getElementById('checkedIn').textContent = checkedIn;
        document.getElementById('notCheckedIn').textContent = notCheckedIn;
        document.getElementById('absent').textContent = absent;
    }

    // Set default week start to next Monday
    function setDefaultWeekStart() {
        const nextMonday = getMonday(addDays(new Date(), 7));
        document.getElementById('weekStartInput').value = formatDate(nextMonday);
    }

    // Handle shift type change to enable/disable time inputs
    document.addEventListener('DOMContentLoaded', () => {
        loadData();

        document.getElementById('weekScheduleTable').addEventListener('change', (e) => {
            if (e.target.classList.contains('shift-type')) {
                const day = e.target.dataset.day;
                const startInput = document.querySelector(`.shift-start[data-day="${day}"]`);
                const endInput = document.querySelector(`.shift-end[data-day="${day}"]`);

                if (e.target.value === 'OFF') {
                    startInput.disabled = true;
                    endInput.disabled = true;
                    startInput.value = '';
                    endInput.value = '';
                } else {
                    startInput.disabled = false;
                    endInput.disabled = false;

                    // Set default times based on shift type
                    const defaults = {
                        'MORNING': ['06:00', '14:00'],
                        'AFTERNOON': ['14:00', '22:00'],
                        'EVENING': ['18:00', '02:00'],
                        'NIGHT': ['22:00', '06:00'],
                        'FULL_DAY': ['08:00', '20:00']
                    };

                    const [start, end] = defaults[e.target.value] || ['08:00', '17:00'];
                    startInput.value = start;
                    endInput.value = end;
                }
            }
        });
    });

    // Auto refresh every 2 minutes
    setInterval(() => {
        console.log('Auto refreshing...');
        loadData();
    }, 120000);
</script>
</body>
</html>