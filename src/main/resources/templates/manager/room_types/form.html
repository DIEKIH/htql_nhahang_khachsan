<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${roomTypeId != null ? 'Sửa loại phòng' : 'Thêm loại phòng'}">Quản lý loại phòng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/manager_sidebar.css}">
    <style>
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-container {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #0d6efd;
        }
        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.1);
        }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid">
    <div class="row">
        <div th:replace="fragments/manager_sidebar :: manager_sidebar"></div>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <!-- Header -->
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="/manager">
                            <i class="bi bi-building"></i> Manager Dashboard
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="/manager/logout">
                                <i class="bi bi-box-arrow-right"></i> Đăng xuất
                            </a>
                        </div>
                    </div>
                </nav>
            </div>


            <div class="row">
                <!-- Main Content -->
                <div class="col-12">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/manager">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="/manager/room-types">Loại phòng</a></li>
                            <li class="breadcrumb-item active" th:text="${roomTypeId != null ? 'Chỉnh sửa' : 'Thêm mới'}"></li>
                        </ol>
                    </nav>

                    <!-- Page Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>
                            <i class="bi bi-door-open"></i>
                            <span th:text="${roomTypeId != null ? 'Chỉnh sửa loại phòng' : 'Thêm loại phòng mới'}"></span>
                        </h2>
                        <a href="/manager/room-types" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                    </div>

                    <!-- Form -->
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-form"></i> Thông tin loại phòng
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" enctype="multipart/form-data"
                                          th:action="${roomTypeId != null ? '/manager/room-types/' + roomTypeId + '/edit' : '/manager/room-types/add'}"
                                          th:object="${roomTypeRequest}">

                                        <div class="row">
                                            <!-- Tên loại phòng -->
                                            <div class="col-md-6 mb-3">
                                                <label for="name" class="form-label">
                                                    Tên loại phòng <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="name" th:field="*{name}"
                                                       th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                                                       placeholder="VD: Phòng Standard">
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}"
                                                     th:errors="*{name}"></div>
                                            </div>

                                            <!-- Giá phòng -->
                                            <div class="col-md-6 mb-3">
                                                <label for="price" class="form-label">
                                                    Giá phòng/đêm (VNĐ) <span class="text-danger">*</span>
                                                </label>
                                                <input type="number" class="form-control" id="price" th:field="*{price}"
                                                       th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''"
                                                       min="0" step="1000" placeholder="500000">
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}"
                                                     th:errors="*{price}"></div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Số khách tối đa -->
                                            <div class="col-md-4 mb-3">
                                                <label for="maxOccupancy" class="form-label">
                                                    Số khách tối đa <span class="text-danger">*</span>
                                                </label>
                                                <input type="number" class="form-control" id="maxOccupancy" th:field="*{maxOccupancy}"
                                                       th:classappend="${#fields.hasErrors('maxOccupancy')} ? 'is-invalid' : ''"
                                                       min="1" max="10" placeholder="2">
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('maxOccupancy')}"
                                                     th:errors="*{maxOccupancy}"></div>
                                            </div>

                                            <!-- Loại giường -->
                                            <div class="col-md-4 mb-3">
                                                <label for="bedType" class="form-label">Loại giường</label>
                                                <select class="form-select" id="bedType" th:field="*{bedType}">
                                                    <option value="">Chọn loại giường</option>
                                                    <option value="Giường đơn">Giường đơn</option>
                                                    <option value="Giường đôi">Giường đôi</option>
                                                    <option value="Giường King">Giường King</option>
                                                    <option value="Giường Queen">Giường Queen</option>
                                                    <option value="2 giường đơn">2 giường đơn</option>
                                                </select>
                                            </div>

                                            <!-- Diện tích -->
                                            <div class="col-md-4 mb-3">
                                                <label for="roomSize" class="form-label">Diện tích (m²)</label>
                                                <input type="number" class="form-control" id="roomSize" th:field="*{roomSize}"
                                                       min="0" step="0.1" placeholder="25.5">
                                            </div>
                                        </div>

                                        <!-- Mô tả -->
                                        <div class="mb-3">
                                            <label for="description" class="form-label">Mô tả</label>
                                            <textarea class="form-control" id="description" th:field="*{description}"
                                                      rows="3" placeholder="Mô tả chi tiết về loại phòng..."></textarea>
                                        </div>

                                        <!-- Tiện nghi -->
                                        <div class="mb-3">
                                            <label for="amenities" class="form-label">Tiện nghi</label>
                                            <div class="row" id="amenitiesContainer">
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="WiFi miễn phí" id="wifi">
                                                        <label class="form-check-label" for="wifi">WiFi miễn phí</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="Điều hòa" id="ac">
                                                        <label class="form-check-label" for="ac">Điều hòa</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="TV màn hình phẳng" id="tv">
                                                        <label class="form-check-label" for="tv">TV màn hình phẳng</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="Tủ lạnh mini" id="fridge">
                                                        <label class="form-check-label" for="fridge">Tủ lạnh mini</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="Phòng tắm riêng" id="bathroom">
                                                        <label class="form-check-label" for="bathroom">Phòng tắm riêng</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input amenity-checkbox" type="checkbox" value="Ban công" id="balcony">
                                                        <label class="form-check-label" for="balcony">Ban công</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="amenities" th:field="*{amenities}">
                                        </div>

                                        <!-- Upload ảnh -->
                                        <div class="mb-3">
                                            <label class="form-label">Hình ảnh phòng</label>

                                            <!-- Upload area -->
                                            <div class="upload-area mb-3" id="uploadArea">
                                                <i class="bi bi-cloud-upload fs-1 text-muted mb-3 d-block"></i>
                                                <p class="text-muted mb-2">Kéo thả ảnh vào đây hoặc</p>
                                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageFiles').click()">
                                                    <i class="bi bi-plus-circle"></i> Chọn ảnh
                                                </button>
                                                <input type="file" id="imageFiles" name="imageFiles" multiple accept="image/*" style="display: none;">
                                                <div class="form-text mt-2">Hỗ trợ: JPG, PNG, GIF (Tối đa 10 ảnh, mỗi ảnh 5MB)</div>
                                            </div>

                                            <!-- Preview existing images (for edit mode) -->
                                            <div id="existingImages" class="mb-3">
                                                <!-- Existing images will be loaded here -->
                                            </div>

                                            <!-- Preview new uploaded images -->
                                            <div id="imagePreview"></div>
                                        </div>

                                        <!-- Trạng thái -->
                                        <div class="mb-4">
                                            <label for="status" class="form-label">
                                                Trạng thái <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="status" th:field="*{status}"
                                                    th:classappend="${#fields.hasErrors('status')} ? 'is-invalid' : ''">
                                                <option value="">Chọn trạng thái</option>
                                                <option th:each="status : ${statuses}"
                                                        th:value="${status}"
                                                        th:text="${status == T(com.example.htql_nhahang_khachsan.enums.Status).ACTIVE ? 'Hoạt động' : 'Không hoạt động'}">
                                                </option>
                                            </select>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('status')}"
                                                 th:errors="*{status}"></div>
                                        </div>

                                        <!-- Buttons -->
                                        <div class="d-flex justify-content-between">
                                            <a href="/manager/room-types" class="btn btn-secondary">
                                                <i class="bi bi-x-circle"></i> Hủy
                                            </a>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle"></i>
                                                <span th:text="${roomTypeId != null ? 'Cập nhật' : 'Thêm mới'}"></span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const amenityCheckboxes = document.querySelectorAll('.amenity-checkbox');
        const amenitiesInput = document.getElementById('amenities');
        const imageFilesInput = document.getElementById('imageFiles');
        const imagePreview = document.getElementById('imagePreview');
        const uploadArea = document.getElementById('uploadArea');
        const existingImagesContainer = document.getElementById('existingImages');

        let selectedFiles = [];
        let existingImageIds = [];

        // Load existing amenities
        if (amenitiesInput.value) {
            try {
                const existingAmenities = JSON.parse(amenitiesInput.value);
                amenityCheckboxes.forEach(checkbox => {
                    if (existingAmenities.includes(checkbox.value)) {
                        checkbox.checked = true;
                    }
                });
            } catch (e) {
                console.error('Error parsing amenities:', e);
            }
        }

        // Load existing images for edit mode
        if (window.existingImages && window.existingImages.length > 0) {
            existingImagesContainer.innerHTML = '<h6 class="mb-3">Ảnh hiện tại:</h6>';
            window.existingImages.forEach(image => {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.innerHTML = `
                    <img src="${image.imageUrl}" class="image-preview" alt="${image.imageTitle || 'Room image'}">
                    <button type="button" class="remove-image" onclick="removeExistingImage(${image.id}, this)">
                        <i class="bi bi-x"></i>
                    </button>
                    <div class="text-center mt-1 small">${image.imageTitle || 'Ảnh ' + (image.displayOrder || '')}</div>
                `;
                existingImagesContainer.appendChild(imageContainer);
                existingImageIds.push(image.id);
            });
        }

        // Update amenities when checkboxes change
        amenityCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const selectedAmenities = [];
                amenityCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedAmenities.push(cb.value);
                    }
                });
                amenitiesInput.value = JSON.stringify(selectedAmenities);
            });
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        // File input change
        imageFilesInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            const maxFiles = 10;
            const maxSize = 5 * 1024 * 1024; // 5MB

            // Filter valid image files
            const validFiles = files.filter(file => {
                if (!file.type.startsWith('image/')) {
                    alert(file.name + ' không phải là file ảnh!');
                    return false;
                }
                if (file.size > maxSize) {
                    alert(file.name + ' quá lớn! Tối đa 5MB.');
                    return false;
                }
                return true;
            });

            // Check total files limit
            if (selectedFiles.length + validFiles.length > maxFiles) {
                alert(`Chỉ được upload tối đa ${maxFiles} ảnh!`);
                return;
            }

            // Add to selected files
            selectedFiles = selectedFiles.concat(validFiles);
            updateFileInput();
            displayImages();
        }

        function updateFileInput() {
            // Create new DataTransfer to update file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            imageFilesInput.files = dt.files;
        }

        function displayImages() {
            imagePreview.innerHTML = '';
            if (selectedFiles.length > 0) {
                const title = document.createElement('h6');
                title.className = 'mb-3';
                title.textContent = 'Ảnh mới được chọn:';
                imagePreview.appendChild(title);
            }

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    imageContainer.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="Preview">
                        <button type="button" class="remove-image" onclick="removeImage(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="text-center mt-1 small">${file.name}</div>
                    `;
                    imagePreview.appendChild(imageContainer);
                };
                reader.readAsDataURL(file);
            });
        }

        // Make functions global
        window.removeImage = function(index) {
            selectedFiles.splice(index, 1);
            updateFileInput();
            displayImages();
        };

        window.removeExistingImage = function(imageId, buttonElement) {
            if (confirm('Bạn có chắc muốn xóa ảnh này?')) {
                // Add to deletion list
                const deletionInput = document.createElement('input');
                deletionInput.type = 'hidden';
                deletionInput.name = 'deleteImageIds';
                deletionInput.value = imageId;
                document.querySelector('form').appendChild(deletionInput);

                // Remove from UI
                buttonElement.parentElement.remove();
            }
        };

        // Initialize on page load
        const event = new Event('change');
        if (amenityCheckboxes.length > 0) {
            amenityCheckboxes[0].dispatchEvent(event);
        }
    });
</script>
</body>
</html>